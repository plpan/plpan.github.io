<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="kubernetes,docker,containers," />





  <link rel="alternate" href="/atom.xml" title="Stupig" type="application/atom+xml" />






<meta name="description" content="背景近期，线上报障了多起Pod删除失败的Case，用户的多次删除请求均已失败告终。Pod删除失败的影响主要有二：  面向用户：用户体验下降，且无法对该Pod执行后续的发布流程 面向弹性云：失败率提升，SLA无法达标  并且，随着弹性云Docker版本升级 (1.13 → 18.06) 进度的推进，线上出现Pod删除失败的Case隐隐有增多的趋势。 线上问题无小事！不论是从哪个角度出发，我们都应该给">
<meta property="og:type" content="article">
<meta property="og:title" content="pod terminating 排查之旅(二)">
<meta property="og:url" content="https://plpan.github.io/pod-terminating-%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85-%E4%BA%8C/index.html">
<meta property="og:site_name" content="Stupig">
<meta property="og:description" content="背景近期，线上报障了多起Pod删除失败的Case，用户的多次删除请求均已失败告终。Pod删除失败的影响主要有二：  面向用户：用户体验下降，且无法对该Pod执行后续的发布流程 面向弹性云：失败率提升，SLA无法达标  并且，随着弹性云Docker版本升级 (1.13 → 18.06) 进度的推进，线上出现Pod删除失败的Case隐隐有增多的趋势。 线上问题无小事！不论是从哪个角度出发，我们都应该给">
<meta property="og:locale">
<meta property="og:image" content="https://plpan.github.io/pod-terminating-%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85-%E4%BA%8C/containerd-shim">
<meta property="article:published_time" content="2021-06-24T08:39:23.000Z">
<meta property="article:modified_time" content="2021-06-27T09:06:45.811Z">
<meta property="article:author" content="plpan">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="containers">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://plpan.github.io/pod-terminating-%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85-%E4%BA%8C/containerd-shim">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://plpan.github.io/pod-terminating-排查之旅-二/"/>





  <title>pod terminating 排查之旅(二) | Stupig</title>
  








<meta name="generator" content="Hexo 5.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stupig</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://plpan.github.io/pod-terminating-%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stupig">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">pod terminating 排查之旅(二)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-24T16:39:23+08:00">
                2021-06-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" itemprop="url" rel="index">
                    <span itemprop="name">问题排查</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>近期，线上报障了多起Pod删除失败的Case，用户的多次删除请求均已失败告终。Pod删除失败的影响主要有二：</p>
<ul>
<li>面向用户：用户体验下降，且无法对该Pod执行后续的发布流程</li>
<li>面向弹性云：失败率提升，SLA无法达标</li>
</ul>
<p>并且，随着弹性云Docker版本升级 (1.13 → 18.06) 进度的推进，线上出现Pod删除失败的Case隐隐有增多的趋势。</p>
<p>线上问题无小事！不论是从哪个角度出发，我们都应该给线上环境把把脉，看看是哪个系统出了问题。</p>
<h3 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h3><p>由于线上出Case的频率并不低，基本每周都会出现，这反而给我们定位问题带来了便利^_^。</p>
<p>排查线上问题的思路一般分如下两个步骤：</p>
<ul>
<li>定位出现问题的组件</li>
<li>定位组件出现的问题</li>
</ul>
<h4 id="组件定位"><a href="#组件定位" class="headerlink" title="组件定位"></a>组件定位</h4><p>对于弹性云的同学来说，定位问题组件已经有一套标准流程：从上往下，看看问题是由哪个组件引起。【不清楚组件通信流程的同学可以看看<a href="https://plpan.github.io/pod-terminating-%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85/">容器删除失败排查</a>】</p>
<p>1）第一嫌疑人：kubelet</p>
<p>在kubernetes体系架构下，删除Pod的执行者就是kubelet，作为第一个提审对象，它不冤。</p>
<p>虽然无奈，但是kubelet也早已习惯了，并且在多次经历过社会的毒打之后，练就了一身的甩锅能力：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I0624 <span class="number">11</span>:<span class="number">00</span>:<span class="number">26.658872</span>   <span class="number">21280</span> kubelet.go:<span class="number">1923</span>] skipping pod synchronization - [PLEG <span class="keyword">is</span> <span class="keyword">not</span> healthy: pleg was last seen active <span class="number">3</span>m0<span class="number">.439656895</span>s ago; threshold <span class="keyword">is</span> <span class="number">3</span>m0s]</span><br></pre></td></tr></table></figure>

<p>什么意思？死贫道不死道友呗。</p>
<p>PLEG模块不健康？<code>PLEG</code>是kubelet的一个子模块单元，用来统一管理底层容器的运行状态。</p>
<p>kubelet招供：我是好人啊，不能冤枉我，都是docker惹的祸！</p>
<p>2）第二嫌疑人：dockerd</p>
<p>根据kubelet的证词，我们很快提审本案的第二嫌疑人：dockerd。</p>
<p>为自证清白，dockerd三下五除二打出一套军体拳：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker ps</span></span><br><span class="line"><span class="regexp">//</span> 运行正常，dockerd轻舒一口气</span><br><span class="line"><span class="comment"># docker ps -a | grep -V NAMES | awk &#x27;&#123;print $1&#125;&#x27; | xargs -ti docker inspect -f &#123;&#123;.State.Pid&#125;&#125; &#123;&#125;</span></span><br><span class="line"><span class="regexp">//</span> 执行到 docker inspect -f &#123;&#123;.State.Pid&#125;&#125; <span class="number">60</span>f253d59f26 时，命令卡住</span><br></pre></td></tr></table></figure>

<p>该容器恰好属于用户删除失败的Pod。</p>
<p>你们可能没看到当时dockerd的脸色，面如死灰，且一直喃喃自语：难道真是我的锅？</p>
<p>好几分钟后，dockerd才慢慢缓过来，理了理思绪，想好了一套甩锅流程：虽然问题出现在我这，但是你们的证据不足，不能证明是我亲手干的。我手下养着一大帮人，可能是一些小弟自己偷偷干的。</p>
<p>嘿，你还有理了，那好，我继续收集证据，让你死的明明白白。</p>
<p>3）第三嫌疑人：containerd</p>
<p>作为dockerd手下的二当家，我们首先传讯了containerd。这人一看就老实忠厚，它看着dockerd的证词，苦笑了下，吐槽到：跟着大哥这么多年，还是没有得到大哥的信任（所以kubernetes在1.20版本中，将containerd扶上了大哥的位置？哈哈）。</p>
<p>containerd有条不紊的祭出三板斧：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># docker-containerd-ctr -a <span class="regexp">/var/</span>run<span class="regexp">/docker/</span>containerd/docker-containerd.sock -n moby c ls</span><br><span class="line"><span class="comment">// 运行正常</span></span><br><span class="line"># docker-containerd-ctr -a <span class="regexp">/var/</span>run<span class="regexp">/docker/</span>containerd/docker-containerd.sock -n moby t ls</span><br><span class="line"><span class="comment">// 命令卡死，containerd老脸一僵，但是很快恢复正常</span></span><br><span class="line"># docker-containerd-ctr -a <span class="regexp">/var/</span>run<span class="regexp">/docker/</span>containerd<span class="regexp">/docker-containerd.sock -n moby c ls | grep -v IMAGE | awk &#x27;&#123;print $1&#125;&#x27; | xargs -ti docker-containerd-ctr -a /</span>var<span class="regexp">/run/</span>docker<span class="regexp">/containerd/</span>docker-containerd.sock -n moby t ps &#123;&#125;</span><br><span class="line"><span class="comment">// 执行到 docker-containerd-ctr -a /var/run/docker/containerd/docker-containerd.sock -n moby t ps 60f253d59f26e1c573d4ba5f824e73b3a4b1bb1629edace85caba4c620755d4d 时，命令卡住</span></span><br></pre></td></tr></table></figure>

<p>containerd神色不自然的说：不好意思啊，警官，可能是我家里不争气的孩子惹的祸，这孩子以前也犯过事【<a href="https://plpan.github.io/docker-hang-%E6%AD%BB%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85/">docker hang 死排查</a>】。</p>
<p>4）第四嫌疑人：containerd-shim</p>
<p>containerd的话还没说完，待在一旁的儿子containerd-shim跳出来指着containerd叛逆地说：你凭什么说是我？你自己干的那些破事，我都不稀罕说你。</p>
<p>清官难断家务事！案件排查至此，从已知证据，还真不好确认到底是老子，还是儿子犯的罪。</p>
<p>5）第五嫌疑人：runc</p>
<p>万般无奈，我们清楚了本案的最后一个嫌疑人，也是年纪最小的runc。runc只会呀呀自语地说：不是我，不是我！</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-runc --root /var/run/docker/runtime-runc/moby/ list</span></span><br><span class="line"><span class="attribute">60f253d59f26e1c573d4ba5f824e73b3a4b1bb1629edace85caba4c620755d4d</span>   <span class="number">0</span>           stopped     /run/docker/containerd/daemon/io.containerd.runtime.v<span class="number">1</span>.linux/moby/<span class="number">60</span>f<span class="number">253</span>d<span class="number">59</span>f<span class="number">26</span>e<span class="number">1</span>c<span class="number">573</span>d<span class="number">4</span>ba<span class="number">5</span>f<span class="number">824</span>e<span class="number">73</span>b<span class="number">3</span>a<span class="number">4</span>b<span class="number">1</span>bb<span class="number">1629</span>edace<span class="number">85</span>caba<span class="number">4</span>c<span class="number">620755</span>d<span class="number">4</span>d   <span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span>T<span class="number">12</span>:<span class="number">43</span>:<span class="number">02</span>.<span class="number">62261156</span>Z    root</span><br></pre></td></tr></table></figure>

<p>从现场收集到的证据表明，这个案件和runc还真没什么关系，案发时，它已经离开了现场，只不过留下了一个烂摊子等着别人来清理。</p>
<p>从众人招供的语录来看，案件嫌疑人初步锁定了containerd与containerd-shim，但是具体是谁，都还不好说。</p>
<p>正当大家一筹莫展之际，一位老刑警从现场提取到了一些新的线索，案件终于有了新的进展。</p>
<p>6）新线索</p>
<p>老刑警领着大家观察它收集到的新线索：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo docker ps -a | grep PODNAME</span></span><br><span class="line"><span class="string">60f253d59f26</span>  <span class="string">image</span>      <span class="string">&quot;/dockerinit&quot;</span>  <span class="number">6</span> <span class="string">weeks</span> <span class="string">ago</span>    <span class="string">Up</span> <span class="number">6</span> <span class="string">weeks</span>                        <span class="string">k8s_CNAME_PODNAME_default_013e3b0e-8d17-11eb-8ef7-246e9693e13c_10</span></span><br><span class="line"><span class="string">6e6fc586dc12</span>  <span class="string">pause:3.1</span>  <span class="string">&quot;/pause&quot;</span>       <span class="number">6</span> <span class="string">weeks</span> <span class="string">ago</span>    <span class="string">Exited</span> <span class="string">(0)</span> <span class="string">About</span> <span class="string">an</span> <span class="string">hour</span> <span class="string">ago</span>      <span class="string">k8s_POD_PODNAME_default_013e3b0e-8d17-11eb-8ef7-246e9693e13c_1</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># ps -ef|grep 60f253d59f26</span></span><br><span class="line"><span class="string">root</span>      <span class="number">119820</span>    <span class="number">3608  </span><span class="number">0</span> <span class="string">May07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:11:16</span> <span class="string">docker-containerd-shim</span> <span class="string">-namespace</span> <span class="string">moby</span> <span class="string">-workdir</span> <span class="string">/docker/docker_rt/containerd/daemon/io.containerd.runtime.v1.linux/moby/60f253d59f26e1c573d4ba5f824e73b3a4b1bb1629edace85caba4c620755d4d</span> <span class="string">-address</span> <span class="string">/var/run/docker/containerd/docker-containerd.sock</span> <span class="string">-containerd-binary</span> <span class="string">/usr/bin/docker-containerd</span> <span class="string">-runtime-root</span> <span class="string">/var/run/docker/runtime-runc</span></span><br><span class="line"><span class="string">stupig</span>    <span class="number">1629698</span> <span class="number">1599793</span>  <span class="number">0</span> <span class="number">11</span><span class="string">:44</span> <span class="string">pts/0</span>    <span class="number">00</span><span class="string">:00:00</span> <span class="string">grep</span> <span class="string">--color=auto</span> <span class="string">60f253d59f26</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># ps -ef|grep 119820</span></span><br><span class="line"><span class="string">root</span>       <span class="number">40825</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun04</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>      <span class="number">40833</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun04</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>      <span class="number">119820</span>    <span class="number">3608  </span><span class="number">0</span> <span class="string">May07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:11:16</span> <span class="string">docker-containerd-shim</span> <span class="string">-namespace</span> <span class="string">moby</span> <span class="string">-workdir</span> <span class="string">/docker/docker_rt/containerd/daemon/io.containerd.runtime.v1.linux/moby/60f253d59f26e1c573d4ba5f824e73b3a4b1bb1629edace85caba4c620755d4d</span> <span class="string">-address</span> <span class="string">/var/run/docker/containerd/docker-containerd.sock</span> <span class="string">-containerd-binary</span> <span class="string">/usr/bin/docker-containerd</span> <span class="string">-runtime-root</span> <span class="string">/var/run/docker/runtime-runc</span></span><br><span class="line"><span class="string">root</span>      <span class="number">119886</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">May07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:04:29</span> [<span class="string">dockerinit</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>      <span class="number">568896</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>     <span class="number">568898</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>      <span class="number">695031</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">May08</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">74647</span>     <span class="number">695037</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">May08</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>      <span class="number">802705</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun09</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">74647</span>     <span class="number">802709</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun09</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>      <span class="number">865131</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">69099</span>     <span class="number">865133</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">1073407</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun23</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">1073428</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun23</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">1375526</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun22</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">69099</span>    <span class="number">1375561</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun22</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">1397568</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun16</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">69099</span>    <span class="number">1397570</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun16</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">1483339</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun23</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">1483341</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun23</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">stupig</span>   <span class="number">1631234</span> <span class="number">1599793</span>  <span class="number">0</span> <span class="number">11</span><span class="string">:44</span> <span class="string">pts/0</span>    <span class="number">00</span><span class="string">:00:00</span> <span class="string">grep</span> <span class="string">--color=auto</span> <span class="number">119820</span></span><br><span class="line"><span class="string">root</span>     <span class="number">1692888</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">1692903</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">1882984</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun21</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">1882985</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun21</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">1964311</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">1964318</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2019760</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">2019784</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2122420</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">2122434</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2288703</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun09</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">69099</span>    <span class="number">2288705</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun09</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2330164</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">2330166</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2406740</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">May27</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">74647</span>    <span class="number">2406745</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">May27</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2421050</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">2421069</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2445918</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun22</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">2445927</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun22</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2487600</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun22</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">2487602</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun22</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="string">root</span>     <span class="number">2897660</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">su</span>] <span class="string">&lt;defunct&gt;</span></span><br><span class="line"><span class="number">76183</span>    <span class="number">2897662</span>  <span class="number">119820</span>  <span class="number">0</span> <span class="string">Jun07</span> <span class="string">?</span>        <span class="number">00</span><span class="string">:00:00</span> [<span class="string">bash</span>] <span class="string">&lt;defunct&gt;</span></span><br></pre></td></tr></table></figure>

<p>同一个Pod内pause容器依然退出，但是业务容器却没有退出，并且业务容器关联的containerd-shim进程并未执行子进程收割动作，就像是卡住了。</p>
<p>面对这些新证据，containerd-shim毫无征兆地崩溃了，大哭道：为什么总是我？</p>
<h4 id="2-2-问题定位"><a href="#2-2-问题定位" class="headerlink" title="2.2 问题定位"></a>2.2 问题定位</h4><p>言归正传，我们如何能根据上述现象快速定位问题呢？思路有三：</p>
<ol>
<li>拿着现象问谷歌</li>
<li>带着问题看代码</li>
<li>深挖现场定问题</li>
</ol>
<p>1）谷歌大法</p>
<p>当我们拿着问题呈现的现象搜索谷歌时，还真搜到了关联的内容：<a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/issues/2709">Exec process may cause shim hang</a>。</p>
<p>该issue中所描述的内容和我们碰到的问题基本一致。问题是由于 <a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/blob/v1.1.2/reaper/reaper.go#L34">reaper.Default</a> 处定义的channel大小太小引起的，调整channel大小可规避该问题。</p>
<p>2）理解代码</p>
<p>尽管本问题可以通过一些手段规避，但是我们还是需要理解代码中出现的问题。</p>
<p>containerd-shim的主要事务是执行runc命令，主要功能是托管真正的容器进程，并暴露一个服务，供外部用户与容器进行交互。</p>
<p>containerd-shim内部处理逻辑如下图所示：</p>
<p><img src="containerd-shim" alt="containerd-shim简单架构"></p>
<p>GRPC服务：containerd-shim的核心服务，对外暴露众多接口，诸如创建/启动task等，并调用runc执行对应的命令。</p>
<p>此外，containerd-shim内启动了三个协程（包含主协程）共同处理容器内进程退出事件。首先是主协程handleSignals：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleSignals</span><span class="params">(logger *logrus.Entry, signals <span class="keyword">chan</span> os.Signal, server *ttrpc.Server, sv *shim.Service)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   signals := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">32</span>)</span><br><span class="line">   signal.Notify(signals, unix.SIGTERM, unix.SIGINT, unix.SIGCHLD, unix.SIGPIPE)</span><br><span class="line">   runc.Monitor = reaper.Default</span><br><span class="line">   <span class="comment">// set the shim as the subreaper for all orphaned processes created by the container</span></span><br><span class="line">   <span class="keyword">if</span> err := system.SetSubreaper(<span class="number">1</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> s := &lt;-signals:</span><br><span class="line">         <span class="keyword">switch</span> s &#123;</span><br><span class="line">         <span class="keyword">case</span> unix.SIGCHLD:</span><br><span class="line">            <span class="keyword">if</span> err := reaper.Reap(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">               logger.WithError(err).Error(<span class="string">&quot;reap exit status&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">         <span class="keyword">case</span> unix.SIGTERM, unix.SIGINT:</span><br><span class="line">            <span class="comment">// shim退出处理</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>containerd-shim调用<code>system.SetSubreaper</code>将自己作为容器内进程的收割者，一般容器内的1号进程也具备收割僵尸进程的能力，因此containerd-shim更多的是收割<code>runc exec</code>进容器内的进程。</p>
<p>当有僵尸进程出现时，就执行收割逻辑：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">Reap</span>() <span class="selector-tag">error</span> &#123;</span><br><span class="line">   <span class="attribute">now </span>:= time.<span class="built_in">Now</span>()</span><br><span class="line">   exits, err := sys.<span class="built_in">Reap</span>(false)          // 调用wait系统调用处理僵尸进程</span><br><span class="line">   Default.<span class="built_in">Lock</span>()</span><br><span class="line">   for c := range Default.subscribers &#123;   // 将退出事件发送给所有订阅者</span><br><span class="line">      for _, e := range exits &#123;</span><br><span class="line">         c &lt;- runc.Exit&#123;</span><br><span class="line">            Timestamp: now,</span><br><span class="line">            Pid:       e.Pid,</span><br><span class="line">            Status:    e.Status,</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="selector-tag">Default</span><span class="selector-class">.Unlock</span>()</span><br><span class="line">   <span class="selector-tag">return</span> <span class="selector-tag">err</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么谁又是订阅者呢？shim在初始化时就订阅了一份进程退出事件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewService</span><span class="params">(config Config, publisher events.Publisher)</span> <span class="params">(*Service, error)</span></span> &#123;</span><br><span class="line">   s := &amp;Service&#123;</span><br><span class="line">      processes: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]proc.Process),</span><br><span class="line">      events:    <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">128</span>),</span><br><span class="line">      ec:        reaper.Default.Subscribe(),    <span class="comment">// 订阅进程退出事件</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">go</span> s.processExits()                          <span class="comment">// 退出事件处理</span></span><br><span class="line">   <span class="keyword">go</span> s.forward(publisher)                      <span class="comment">// 退出事件转发</span></span><br><span class="line">   <span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中退出事件处理逻辑如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span> <span class="title">processExits</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">for</span> e := <span class="keyword">range</span> s.ec &#123;</span><br><span class="line">      s.checkProcesses(e)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span> <span class="title">checkProcesses</span><span class="params">(e runc.Exit)</span></span> &#123;</span><br><span class="line">   s.mu.Lock()</span><br><span class="line">   <span class="keyword">defer</span> s.mu.Unlock()</span><br><span class="line">   <span class="keyword">for</span> _, p := <span class="keyword">range</span> s.processes &#123;</span><br><span class="line">      <span class="keyword">if</span> p.Pid() == e.Pid &#123;</span><br><span class="line">         s.events &lt;- &amp;eventstypes.TaskExit&#123;&#125;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只处理<code>s.processes</code>的退出事件，而<code>s.processes</code>关联的都是什么对象呢？主要有二：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a new initial process and container with the underlying OCI runtime</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span> <span class="title">Create</span><span class="params">(ctx context.Context, r *shimapi.CreateTaskRequest)</span> <span class="params">(*shimapi.CreateTaskResponse, error)</span></span> &#123;</span><br><span class="line">   ......</span><br><span class="line">   s.processes[r.ID] = process</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Exec an additional process inside the container</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Service)</span> <span class="title">Exec</span><span class="params">(ctx context.Context, r *shimapi.ExecProcessRequest)</span> <span class="params">(*ptypes.Empty, error)</span></span> &#123;</span><br><span class="line">   ......</span><br><span class="line">   s.processes[r.ID] = process</span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码就展示这些，其他代码大家感兴趣的自己查阅。</p>
<p>现在，我们再来根据现象查问题。从现象可知，异常容器待收割的僵尸进程较多，肯定超过了32个。当shim在收割众多僵尸进程时，往订阅者信道(大小32)中发送时，出现阻塞，阻塞点：<a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/blob/v1.1.2/reaper/reaper.go#L44">阻塞信号</a>，并且此时持有<code>Default.Lock</code>这一把大锁。</p>
<p>那么只要这时候再有人来申请这把锁，就会形成死锁。</p>
<p>那么究竟谁会来申请这把锁呢？这时候，要是能查看containerd-shim的协程栈就好了。</p>
<p>3）现场分析</p>
<p>确实，containerd-shim启动了一个协程方便用户导出协程栈信息，我们来看看能不能行呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">executeShim</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">   dump := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">32</span>)</span><br><span class="line">   signal.Notify(dump, syscall.SIGUSR1)</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">range</span> dump &#123;</span><br><span class="line">         dumpStacks(logger)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dumpStacks</span><span class="params">(logger *logrus.Entry)</span></span> &#123;</span><br><span class="line">   <span class="keyword">var</span> (</span><br><span class="line">      buf       []<span class="keyword">byte</span></span><br><span class="line">      stackSize <span class="keyword">int</span></span><br><span class="line">   )</span><br><span class="line">   bufferLen := <span class="number">16384</span></span><br><span class="line">   <span class="keyword">for</span> stackSize == <span class="built_in">len</span>(buf) &#123;</span><br><span class="line">      buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufferLen)</span><br><span class="line">      stackSize = runtime.Stack(buf, <span class="literal">true</span>)</span><br><span class="line">      bufferLen *= <span class="number">2</span></span><br><span class="line">   &#125;</span><br><span class="line">   buf = buf[:stackSize]</span><br><span class="line">   logger.Infof(<span class="string">&quot;=== BEGIN goroutine stack dump ===\n%s\n=== END goroutine stack dump ===&quot;</span>, buf)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一切看起来貌似没什么问题，我们发送<code>SIGUSR1</code>就能获取一份协程栈。</p>
<p>当我们真正去执行时，却发现到处了一个寂寞。根本原因在于：</p>
<ul>
<li>logger.Infof()往os.Stdout输出</li>
<li>由于线上环境docker没有开启<code>debug</code>模式，线上containerd-shim的os.Stdout被赋值为<code>/dev/null</code></li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">COMMAND</span>       PID USER   FD      TYPE             DEVICE SIZE/<span class="literal">OFF</span>       NODE NAME</span><br><span class="line"><span class="attribute">docker</span>-co  <span class="number">119820</span> root  cwd       DIR               <span class="number">0</span>,<span class="number">18</span>      <span class="number">120</span>  <span class="number">916720892</span> /run/docker/containerd/daemon/io.containerd.runtime.v<span class="number">1</span>.linux/moby/<span class="number">60</span>f<span class="number">253</span>d<span class="number">59</span>f<span class="number">26</span>e<span class="number">1</span>c<span class="number">573</span>d<span class="number">4</span>ba<span class="number">5</span>f<span class="number">824</span>e<span class="number">73</span>b<span class="number">3</span>a<span class="number">4</span>b<span class="number">1</span>bb<span class="number">1629</span>edace<span class="number">85</span>caba<span class="number">4</span>c<span class="number">620755</span>d<span class="number">4</span>d</span><br><span class="line"><span class="attribute">docker</span>-co  <span class="number">119820</span> root  rtd       DIR                <span class="number">8</span>,<span class="number">3</span>     <span class="number">4096</span>          <span class="number">2</span> /</span><br><span class="line"><span class="attribute">docker</span>-co  <span class="number">119820</span> root  txt       REG                <span class="number">8</span>,<span class="number">3</span>  <span class="number">4173632</span>     <span class="number">392525</span> /usr/bin/docker-containerd-shim</span><br><span class="line"><span class="attribute">docker</span>-co  <span class="number">119820</span> root    <span class="number">0</span>r      CHR                <span class="number">1</span>,<span class="number">3</span>      <span class="number">0</span>t<span class="number">0</span>       <span class="number">2052</span> /dev/null</span><br><span class="line"><span class="attribute">docker</span>-co  <span class="number">119820</span> root    <span class="number">1</span>w      CHR                <span class="number">1</span>,<span class="number">3</span>      <span class="number">0</span>t<span class="number">0</span>       <span class="number">2052</span> /dev/null</span><br><span class="line"><span class="attribute">docker</span>-co  <span class="number">119820</span> root    <span class="number">2</span>w      CHR                <span class="number">1</span>,<span class="number">3</span>      <span class="number">0</span>t<span class="number">0</span>       <span class="number">2052</span> /dev/null</span><br></pre></td></tr></table></figure>

<p>问题排查至此，似乎又僵住了！好在，之前看过一丢丢内核问题排查相关知识。虽然线上containerd-shim将协程栈的信息全部导出到了<code>/dev/null</code>中，但是我们还是有一些手段获取。</p>
<p>赶紧找组里的内核大佬帮忙，并很快确定了方案，基于kprobe，在操作系统往<code>/dev/null</code>设备写入协程栈时，拷贝一份内容写到内核日志中。方案实施起来也不复杂：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kprobes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> pid;</span><br><span class="line">module_param(pid, <span class="keyword">int</span>, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kprobe</span> <span class="title">kp</span> =</span> &#123;</span><br><span class="line">    .symbol_name    = <span class="string">&quot;write_null&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEGMENT 512</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handler_pre</span><span class="params">(struct kprobe *p, struct pt_regs *regs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *wbuf;</span><br><span class="line">    <span class="keyword">size_t</span> count, place = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (pid != current-&gt;tgid) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    count = (<span class="keyword">size_t</span>)(regs-&gt;dx);</span><br><span class="line"> </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;%u call write_null count: %lu\n&quot;</span>, current-&gt;tgid, count);</span><br><span class="line"> </span><br><span class="line">    wbuf = (<span class="keyword">char</span> *)kmalloc(count + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (wbuf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(wbuf, <span class="number">0x0</span>, count + <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(wbuf, (<span class="keyword">void</span> *)regs-&gt;si, count)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;copy_from_user fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span> (place &lt; count) &#123;</span><br><span class="line">        <span class="keyword">char</span> tmp[SEGMENT + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">memset</span>(tmp, <span class="number">0x0</span>, SEGMENT + <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">snprintf</span>(tmp, SEGMENT + <span class="number">1</span>, <span class="string">&quot;%s&quot;</span>, wbuf + place);</span><br><span class="line">        <span class="keyword">if</span> ((count - place) &gt;= SEGMENT) &#123;</span><br><span class="line">            place += SEGMENT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            place = count;</span><br><span class="line">        &#125;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;%s\n&quot;</span>, tmp);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (wbuf) &#123;</span><br><span class="line">        kfree(wbuf);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">kprobe_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    kp.pre_handler = handler_pre;</span><br><span class="line"> </span><br><span class="line">    ret = register_kprobe(&amp;kp);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;register_kprobe failed, returned %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Planted kprobe at %p\n&quot;</span>, kp.addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">kprobe_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    unregister_kprobe(&amp;kp);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;kprobe at %p unregistered\n&quot;</span>, kp.addr);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(kprobe_init)</span><br><span class="line">module_exit(kprobe_exit)</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里着重感谢睿哥(黄睿大佬)提供的kprobe代码。kprobe的相关知识，感兴趣的自己学习下。</p>
<p>我们在线上部署了该kprobe内核模块之后，往containerd-shim发送<code>SIGUSR1</code>顺利获取了协程栈信息。终于补全了问题排查的最后一块拼盘。</p>
<p>线上containerd-shim的协程栈信息(删减了大量不重要协程栈，并调整了格式)展示如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">time=&quot;2021-06-23T16:35:07+08:00&quot;</span> <span class="string">level=info</span> <span class="string">msg=&quot;===</span> <span class="string">BEGIN</span> <span class="string">goroutine</span> <span class="string">stack</span> <span class="string">dump</span> <span class="string">===</span></span><br><span class="line"><span class="string">goroutine</span> <span class="number">22</span> [<span class="string">running</span>]<span class="string">:</span></span><br><span class="line"><span class="string">main.dumpStacks(0xc4201c81e0)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:228</span> <span class="string">+0x8a</span></span><br><span class="line"><span class="string">main.executeShim.func1(0xc42012c300,</span> <span class="number">0xc4201c81e0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:148</span> <span class="string">+0x3d</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">main.executeShim</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:146</span> <span class="string">+0x5de</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">1</span> [<span class="string">chan</span> <span class="string">send</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/reaper.Reap(0xc420243be0,</span> <span class="number">0x1</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/reaper/reaper.go:44</span> <span class="string">+0x168</span></span><br><span class="line"><span class="string">main.handleSignals(0xc4201c81e0,</span> <span class="number">0xc42012c240</span><span class="string">,</span> <span class="number">0xc4201d6090</span><span class="string">,</span> <span class="number">0xc4201e4000</span><span class="string">,</span> <span class="number">0xc420117ea0</span><span class="string">,</span> <span class="number">0x86</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:197</span> <span class="string">+0x2a1</span></span><br><span class="line"><span class="string">main.executeShim(0x2,</span> <span class="number">0x60</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:151</span> <span class="string">+0x616</span></span><br><span class="line"><span class="string">main.main()</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:96</span> <span class="string">+0x81</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">5</span> [<span class="string">syscall</span>]<span class="string">:</span></span><br><span class="line"><span class="string">os/signal.signal_recv(0x6c14c0)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/sigqueue.go:139</span> <span class="string">+0xa6</span></span><br><span class="line"><span class="string">os/signal.loop()</span></span><br><span class="line">      <span class="string">/usr/local/go/src/os/signal/signal_unix.go:22</span> <span class="string">+0x22</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">os/signal.init.0</span></span><br><span class="line">      <span class="string">/usr/local/go/src/os/signal/signal_unix.go:28</span> <span class="string">+0x41</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">6</span> [<span class="string">chan</span> <span class="string">receive</span>]<span class="string">:</span></span><br><span class="line"><span class="string">main.main.func1()</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:81</span> <span class="string">+0x7b</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">main.main</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:80</span> <span class="string">+0x46</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">7</span> [<span class="string">select</span>, <span class="number">92427</span> <span class="string">minutes</span>, <span class="string">locked</span> <span class="string">to</span> <span class="string">thread</span>]<span class="string">:</span></span><br><span class="line"><span class="string">runtime.gopark(0x6a70a0,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x696b74</span><span class="string">,</span> <span class="number">0x6</span><span class="string">,</span> <span class="number">0x18</span><span class="string">,</span> <span class="number">0x1</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/proc.go:291</span> <span class="string">+0x11a</span></span><br><span class="line"><span class="string">runtime.selectgo(0xc420104f50,</span> <span class="number">0xc42014a180</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/select.go:392</span> <span class="string">+0xe50</span></span><br><span class="line"><span class="string">runtime.ensureSigM.func1()</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/signal_unix.go:549</span> <span class="string">+0x1f4</span></span><br><span class="line"><span class="string">runtime.goexit()</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/asm_amd64.s:2361</span> <span class="string">+0x1</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">18</span> [<span class="string">semacquire</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">sync.runtime_SemacquireMutex(0xc4201e4004,</span> <span class="number">0x403200</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/sema.go:71</span> <span class="string">+0x3d</span></span><br><span class="line"><span class="string">sync.(*Mutex).Lock(0xc4201e4000)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/sync/mutex.go:134</span> <span class="string">+0x108</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/shim.(*Service).checkProcesses(0xc4201e4000,</span> <span class="number">0xc02cd591b40305ef</span><span class="string">,</span> <span class="number">0x13af4280e2630f</span><span class="string">,</span> <span class="number">0x7fc440</span><span class="string">,</span> <span class="number">0x1c11b</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service.go:470</span> <span class="string">+0x45</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/shim.(*Service).processExits(0xc4201e4000)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service.go:465</span> <span class="string">+0xd0</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">github.com/containerd/containerd/linux/shim.NewService</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service.go:86</span> <span class="string">+0x3e9</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">19</span> [<span class="string">syscall</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">syscall.Syscall6(0xe8,</span> <span class="number">0x4</span><span class="string">,</span> <span class="number">0xc4201189b8</span><span class="string">,</span> <span class="number">0x80</span><span class="string">,</span> <span class="number">0xffffffffffffffff</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0xc420118938</span><span class="string">,</span> <span class="number">0x45b793</span><span class="string">,</span> <span class="number">0xc42047add0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/syscall/asm_linux_amd64.s:44</span> <span class="string">+0x5</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/golang.org/x/sys/unix.EpollWait(0x4,</span> <span class="number">0xc4201189b8</span><span class="string">,</span> <span class="number">0x80</span><span class="string">,</span> <span class="number">0x80</span><span class="string">,</span> <span class="number">0xffffffffffffffff</span><span class="string">,</span> <span class="number">0x5</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/golang.org/x/sys/unix/zsyscall_linux_amd64.go:1518</span> <span class="string">+0x7a</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/containerd/console.(*Epoller).Wait(0xc4201be060,</span> <span class="number">0xc420117aa8</span><span class="string">,</span> <span class="number">0xc420117ab0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/containerd/console/console_linux.go:110</span> <span class="string">+0x7a</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">github.com/containerd/containerd/linux/shim.(*Service).initPlatform</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service_linux.go:109</span> <span class="string">+0xc6</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">20</span> [<span class="string">chan</span> <span class="string">receive</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/shim.(*Service).forward(0xc4201e4000,</span> <span class="number">0x6c0600</span><span class="string">,</span> <span class="number">0xc4201d4010</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service.go:514</span> <span class="string">+0x62</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">github.com/containerd/containerd/linux/shim.NewService</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service.go:90</span> <span class="string">+0x49b</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">21</span> [<span class="string">IO</span> <span class="string">wait</span>, <span class="number">92427</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">internal/poll.runtime_pollWait(0x7f75331fcf00,</span> <span class="number">0x72</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/netpoll.go:173</span> <span class="string">+0x57</span></span><br><span class="line"><span class="string">internal/poll.(*pollDesc).wait(0xc4201e6118,</span> <span class="number">0x72</span><span class="string">,</span> <span class="number">0xc420010100</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/internal/poll/fd_poll_runtime.go:85</span> <span class="string">+0x9b</span></span><br><span class="line"><span class="string">internal/poll.(*pollDesc).waitRead(0xc4201e6118,</span> <span class="number">0xffffffffffffff00</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/internal/poll/fd_poll_runtime.go:90</span> <span class="string">+0x3d</span></span><br><span class="line"><span class="string">internal/poll.(*FD).Accept(0xc4201e6100,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/internal/poll/fd_unix.go:372</span> <span class="string">+0x1a8</span></span><br><span class="line"><span class="string">net.(*netFD).accept(0xc4201e6100,</span> <span class="number">0xc4201d60a0</span><span class="string">,</span> <span class="number">0xc4201d6060</span><span class="string">,</span> <span class="number">0xc4201563c0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/net/fd_unix.go:238</span> <span class="string">+0x42</span></span><br><span class="line"><span class="string">net.(*UnixListener).accept(0xc4201d6270,</span> <span class="number">0x451c70</span><span class="string">,</span> <span class="number">0xc42011cea8</span><span class="string">,</span> <span class="number">0xc42011ceb0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/net/unixsock_posix.go:162</span> <span class="string">+0x32</span></span><br><span class="line"><span class="string">net.(*UnixListener).Accept(0xc4201d6270,</span> <span class="number">0x6a6b10</span><span class="string">,</span> <span class="number">0xc4201563c0</span><span class="string">,</span> <span class="number">0x6c3840</span><span class="string">,</span> <span class="number">0xc420012018</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/net/unixsock.go:253</span> <span class="string">+0x49</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*Server).Serve(0xc4201d6090,</span> <span class="number">0x6c3440</span><span class="string">,</span> <span class="number">0xc4201d6270</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:69</span> <span class="string">+0x106</span></span><br><span class="line"><span class="string">main.serve.func1(0x6c3440,</span> <span class="number">0xc4201d6270</span><span class="string">,</span> <span class="number">0xc4201d6090</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:176</span> <span class="string">+0x71</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">main.serve</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/cmd/containerd-shim/main_unix.go:174</span> <span class="string">+0x1be</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">8</span> [<span class="string">select</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serverConn).run(0xc4201563c0,</span> <span class="number">0x6c3840</span><span class="string">,</span> <span class="number">0xc420012018</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:398</span> <span class="string">+0x3f0</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*Server).Serve</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:109</span> <span class="string">+0x25c</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">9</span> [<span class="string">IO</span> <span class="string">wait</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">internal/poll.runtime_pollWait(0x7f75331fce30,</span> <span class="number">0x72</span><span class="string">,</span> <span class="number">0xc42011ea48</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/netpoll.go:173</span> <span class="string">+0x57</span></span><br><span class="line"><span class="string">internal/poll.(*pollDesc).wait(0xc4201a0118,</span> <span class="number">0x72</span><span class="string">,</span> <span class="number">0xffffffffffffff00</span><span class="string">,</span> <span class="number">0x6c0a40</span><span class="string">,</span> <span class="number">0x7e11b8</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/internal/poll/fd_poll_runtime.go:85</span> <span class="string">+0x9b</span></span><br><span class="line"><span class="string">internal/poll.(*pollDesc).waitRead(0xc4201a0118,</span> <span class="number">0xc4201ed000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/internal/poll/fd_poll_runtime.go:90</span> <span class="string">+0x3d</span></span><br><span class="line"><span class="string">internal/poll.(*FD).Read(0xc4201a0100,</span> <span class="number">0xc4201ed000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/internal/poll/fd_unix.go:157</span> <span class="string">+0x17d</span></span><br><span class="line"><span class="string">net.(*netFD).Read(0xc4201a0100,</span> <span class="number">0xc4201ed000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">,</span> <span class="number">0xc42011eb30</span><span class="string">,</span> <span class="number">0x451430</span><span class="string">,</span> <span class="number">0xc420001b00</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/net/fd_unix.go:202</span> <span class="string">+0x4f</span></span><br><span class="line"><span class="string">net.(*conn).Read(0xc42000c050,</span> <span class="number">0xc4201ed000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">,</span> <span class="number">0x1000</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/net/net.go:176</span> <span class="string">+0x6a</span></span><br><span class="line"><span class="string">bufio.(*Reader).Read(0xc42012c480,</span> <span class="number">0xc4200105a0</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x2</span><span class="string">,</span> <span class="number">0x2</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/bufio/bufio.go:216</span> <span class="string">+0x238</span></span><br><span class="line"><span class="string">io.ReadAtLeast(0x6c02c0,</span> <span class="number">0xc42012c480</span><span class="string">,</span> <span class="number">0xc4200105a0</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0x6c62e0</span><span class="string">,</span> <span class="number">0xc42011ef50</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/io/io.go:309</span> <span class="string">+0x86</span></span><br><span class="line"><span class="string">io.ReadFull(0x6c02c0,</span> <span class="number">0xc42012c480</span><span class="string">,</span> <span class="number">0xc4200105a0</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0xc42011eef0</span><span class="string">,</span> <span class="number">0x3</span><span class="string">,</span> <span class="number">0x3</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/io/io.go:327</span> <span class="string">+0x58</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.readMessageHeader(0xc4200105a0,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0xa</span><span class="string">,</span> <span class="number">0x6c02c0</span><span class="string">,</span> <span class="number">0xc42012c480</span><span class="string">,</span> <span class="number">0xc42011ee70</span><span class="string">,</span> <span class="number">0x2</span><span class="string">,</span> <span class="number">0x2</span><span class="string">,</span> <span class="number">0xc42011eed0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/channel.go:38</span> <span class="string">+0x60</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*channel).recv(0xc420010580,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0xc420392940</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x73</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/channel.go:86</span> <span class="string">+0x6d</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serverConn).run.func1(0xc42014a2a0,</span> <span class="number">0xc4201563c0</span><span class="string">,</span> <span class="number">0xc42014a360</span><span class="string">,</span> <span class="number">0xc420010580</span><span class="string">,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc42014a300</span><span class="string">,</span> <span class="number">0xc42012c4e0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:329</span> <span class="string">+0x1bf</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serverConn).run</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:299</span> <span class="string">+0x247</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">22661144</span> [<span class="string">chan</span> <span class="string">receive</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/reaper.(*Monitor).Wait(0x7fb5d0,</span> <span class="number">0xc42017a580</span><span class="string">,</span> <span class="number">0xc420674360</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x68c3c0</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/reaper/reaper.go:82</span> <span class="string">+0x52</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.cmdOutput(0xc42017a580,</span> <span class="number">0x1</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/runc.go:693</span> <span class="string">+0x110</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.(*Runc).runOrError(0xc42018b6c0,</span> <span class="number">0xc42017a580</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc4201d6c30</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/runc.go:673</span> <span class="string">+0x19b</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/containerd/go-runc.(*Runc).Kill(0xc42018b6c0,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc420014480</span><span class="string">,</span> <span class="number">0x40</span><span class="string">,</span> <span class="number">0xf</span><span class="string">,</span> <span class="number">0xc42054bbc7</span><span class="string">,</span> <span class="number">0xc420393080</span><span class="string">,</span> <span class="number">0xc42012d9e0</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/containerd/go-runc/runc.go:320</span> <span class="string">+0x1e2</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/proc.(*Init).kill(0xc42018c3c0,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xf</span><span class="string">,</span> <span class="number">0x40</span><span class="string">,</span> <span class="number">0xc42054bc01</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/proc/init.go:341</span> <span class="string">+0x78</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/proc.(*runningState).Kill(0xc4201ca030,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xf</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/proc/init_state.go:331</span> <span class="string">+0xa5</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/shim.(*Service).Kill(0xc4201e4000,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc42000a940</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service.go:356</span> <span class="string">+0x271</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/shim/v1.RegisterShimService.func10(0x6c3800,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc42000a920</span><span class="string">,</span> <span class="number">0xc4201ce968</span><span class="string">,</span> <span class="number">0x4</span><span class="string">,</span> <span class="number">0xc4201be1a0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/v1/shim.pb.go:1670</span> <span class="string">+0xc5</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serviceSet).dispatch(0xc4201ca008,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc4204e6570</span><span class="string">,</span> <span class="number">0x25</span><span class="string">,</span> <span class="number">0xc4201ce968</span><span class="string">,</span> <span class="number">0x4</span><span class="string">,</span> <span class="number">0xc420226c30</span><span class="string">,</span> <span class="number">0x44</span><span class="string">,</span> <span class="number">0x44</span><span class="string">,</span> <span class="string">...)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/services.go:71</span> <span class="string">+0x10e</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serviceSet).call(0xc4201ca008,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc4204e6570</span><span class="string">,</span> <span class="number">0x25</span><span class="string">,</span> <span class="number">0xc4201ce968</span><span class="string">,</span> <span class="number">0x4</span><span class="string">,</span> <span class="number">0xc420226c30</span><span class="string">,</span> <span class="number">0x44</span><span class="string">,</span> <span class="number">0x44</span><span class="string">,</span> <span class="string">...)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/services.go:44</span> <span class="string">+0xb5</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serverConn).run.func2(0xc4201563c0,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xace455</span><span class="string">,</span> <span class="number">0xc420392900</span><span class="string">,</span> <span class="number">0xc42014a2a0</span><span class="string">,</span> <span class="number">0xc42014a360</span><span class="string">,0xc400ace455)</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:402</span> <span class="string">+0xaa</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serverConn).run</span></span><br><span class="line">    <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:401</span> <span class="string">+0x763</span></span><br><span class="line"> </span><br><span class="line"><span class="string">goroutine</span> <span class="number">22661145</span> [<span class="string">semacquire</span>, <span class="number">83</span> <span class="string">minutes</span>]<span class="string">:</span></span><br><span class="line"><span class="string">sync.runtime_SemacquireMutex(0xc4201e4004,</span> <span class="number">0x64b800</span><span class="string">)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/runtime/sema.go:71</span> <span class="string">+0x3d</span></span><br><span class="line"><span class="string">sync.(*Mutex).Lock(0xc4201e4000)</span></span><br><span class="line">      <span class="string">/usr/local/go/src/sync/mutex.go:134</span> <span class="string">+0x108</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/shim.(*Service).State(0xc4201e4000,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc420120af0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/service.go:271</span> <span class="string">+0x59</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/linux/shim/v1.RegisterShimService.func1(0x6c3800,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc42000a980</span><span class="string">,</span> <span class="number">0xc4201ce988</span><span class="string">,</span> <span class="number">0x5</span><span class="string">,</span> <span class="number">0xc4201be080</span><span class="string">,</span> <span class="number">0x0</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/linux/shim/v1/shim.pb.go:1607</span> <span class="string">+0xc8</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serviceSet).dispatch(0xc4201ca008,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc4204e65a0</span><span class="string">,</span> <span class="number">0x25</span><span class="string">,</span> <span class="number">0xc4201ce988</span><span class="string">,</span> <span class="number">0x5</span><span class="string">,</span> <span class="number">0xc420226c80</span><span class="string">,</span> <span class="number">0x42</span><span class="string">,</span> <span class="number">0x42</span><span class="string">,</span> <span class="string">...)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/services.go:71</span> <span class="string">+0x10e</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serviceSet).call(0xc4201ca008,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xc4204e65a0</span><span class="string">,</span> <span class="number">0x25</span><span class="string">,</span> <span class="number">0xc4201ce988</span><span class="string">,</span> <span class="number">0x5</span><span class="string">,</span> <span class="number">0xc420226c80</span><span class="string">,</span> <span class="number">0x42</span><span class="string">,</span> <span class="number">0x42</span><span class="string">,</span> <span class="string">...)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/services.go:44</span> <span class="string">+0xb5</span></span><br><span class="line"><span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serverConn).run.func2(0xc4201563c0,</span> <span class="number">0x6c3800</span><span class="string">,</span> <span class="number">0xc4200105c0</span><span class="string">,</span> <span class="number">0xace457</span><span class="string">,</span> <span class="number">0xc420392940</span><span class="string">,</span> <span class="number">0xc42014a2a0</span><span class="string">,</span> <span class="number">0xc42014a360</span><span class="string">,</span> <span class="number">0xc400ace457</span><span class="string">)</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:402</span> <span class="string">+0xaa</span></span><br><span class="line"><span class="string">created</span> <span class="string">by</span> <span class="string">github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc.(*serverConn).run</span></span><br><span class="line">      <span class="string">/tmp/tmp.ma5UpKvnFZ/src/github.com/containerd/containerd/vendor/github.com/stevvooe/ttrpc/server.go:401</span> <span class="string">+0x763</span></span><br><span class="line"> </span><br><span class="line"><span class="string">===</span> <span class="string">END</span> <span class="string">goroutine</span> <span class="string">stack</span> <span class="string">dump</span> <span class="string">===&quot;</span> <span class="string">namespace=moby</span> <span class="string">path=&quot;/run/docker/containerd/daemon/io.containerd.runtime.v1.linux/moby/60f253d59f26e1c573d4ba5f824e73b3a4b1bb1629edace85caba4c620755d4d&quot;</span> <span class="string">pid=119820</span></span><br></pre></td></tr></table></figure>

<p>分析以上协程栈可知：</p>
<ul>
<li>goroutine 1：<code>handleSignals</code>确实阻塞在<code>reaper.go:44</code>，导致后续进程无法被收割</li>
<li>goroutine 18：<code>checkProcesses</code>阻塞在<code>service.go:470</code>，获取锁失败，但是并非是<code>reaper.Default</code>这把大锁</li>
<li>goroutine 22661144：<code>shim.(*Service).Kill</code>阻塞在<code>reaper.go:82</code></li>
</ul>
<p>其中，最为异常的是<code>goroutine 22661144</code>，其阻塞点代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Monitor)</span> <span class="title">Wait</span><span class="params">(c *exec.Cmd, ec <span class="keyword">chan</span> runc.Exit)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">   <span class="keyword">for</span> e := <span class="keyword">range</span> ec &#123;                   <span class="comment">// reaper.go:82</span></span><br><span class="line">      <span class="keyword">if</span> e.Pid == c.Process.Pid &#123;</span><br><span class="line">         c.Wait()</span><br><span class="line">         m.Unsubscribe(ec)</span><br><span class="line">         <span class="keyword">return</span> e.Status, <span class="literal">nil</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">-1</span>, ErrNoSuchProcess</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>ec</code>就是<code>reaper.Default</code>的一个订阅方。</p>
<p>死锁的形成如下：</p>
<ul>
<li>goroutine 22661144：等待着关联进程的退出事件到来，并且持有<code>Service.mu</code>这把锁</li>
<li>goroutine 18：等待获取<code>Service.mu</code>这把锁后，再去处理订阅的事件</li>
<li>goroutine 1：往所有订阅方发送事件</li>
</ul>
<p>这三个协程形成了完美的死锁现场。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>清楚了问题的成因之后，解决问题的方案也很简单，只需调整默认的订阅者信道大小即可。社区优化方案有二：</p>
<ul>
<li>调整信道大小，溢出事件自动忽略：<a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/pull/2748/files">https://github.com/containerd/containerd/pull/2748/files</a></li>
<li>优化锁逻辑：<a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/pull/2743">https://github.com/containerd/containerd/pull/2743</a> 【好几个commit】</li>
</ul>
<p>但是，当我们替换containerd-shim后，影响的也仅是在此之后创建的容器，而之前创建的容器仍然会出现该问题。</p>
<p>这个可以通过添加告警自愈的手段解决：直接杀containerd-shim进程。这样所有的进程都会由init进程完成收割。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt=" 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
            <a href="/tags/docker/" rel="tag"># docker</a>
          
            <a href="/tags/containers/" rel="tag"># containers</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/docker-exec-%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B9%8B%E6%97%85/" rel="next" title="docker exec 失败问题排查之旅">
                <i class="fa fa-chevron-left"></i> docker exec 失败问题排查之旅
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="gitalk-container"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/plpan" target="_blank" title="GitHub">
                      GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-text">背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D"><span class="nav-text">问题定位</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6%E5%AE%9A%E4%BD%8D"><span class="nav-text">组件定位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D"><span class="nav-text">2.2 问题定位</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">解决方案</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">plpan</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '334a8866f390a4eaaba2',
      clientSecret: '33515b0cbae23af154a4b0c1cd30bcdc3e52df87',
      repo: 'gitalk',
      owner: 'plpan',
      admin: ['plpan'],
      id:'20210624163923',
      labels: ''.split(',').filter(l => l),
      perPage: 10,
      createIssueManually: false
    })
    gitalk.render('gitalk-container')           
  </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
